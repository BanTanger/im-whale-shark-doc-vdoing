---
title: 消息幂等性模型
date: 2023-08-04 13:02:09
permalink: /pages/e9d894/
---
## 消息幂等性保证
为了实现消息可靠，我们设计了上下行 ACK 以保证应用层两次握手，但问题也很明显，为了可靠性就无法避免的会出现消息重复的现象。

思考这样一个场景：发送方 A 发送一条消息给在线用户 B，已经成功接受到服务端的确认 ACK，等待接收方的确认 ACK，
发送方本地没有接受到下行 ACK，并且计时器也已经超时，A 认为 B 没有接受到数据，进行消息重发，但其实 B 成功接收到数据并已经异步持久化了，
只是由于网络波动没有及时返回确认 ACK，当 A 再次发送消息之后 B 的确认 ACK 才到达，这样就导致了消息重复的现象

我们可以通过一些简单的手段来遏制，比如说防重 id 来防止同一份数据处理多次加载到数据库，

或者是消息到达时做一个缓存，缓存时间尽量短，缓存时间内的消息重试直接让接收方接收消息，不进行二次持久化。

![消息幂等性保证](https://cdn.statically.io/gh/BanTanger/image-hosting@master/IM-WhaleShark-Doc-assert202308041308514.png)

为了避免客户端无限制重发的现象，我们可以对缓存做一个过期时间，只有在过期时间之前的缓存才能做幂等；
当超过缓存时间时, 服务端忽略重投的消息, 直到客户端计时器超时并且已经超过了最大重试次数，
才让客户端重新生成消息唯一id：messageId, 也就是重新做一个消息体

![禁止客户端无限制重发](https://cdn.statically.io/gh/BanTanger/image-hosting@master/IM-WhaleShark-Doc-assert202308041308948.png)