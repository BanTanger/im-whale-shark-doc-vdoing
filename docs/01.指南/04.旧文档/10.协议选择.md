---
title: Netty、私有协议
date: 2023-03-24 16:29:46
permalink: /pages/38e0f7/
categories:
  - 项目
  - 高性能IM即时通讯系统
tags:
  - 
author: 
  name: BanTanger | 半糖
  link: https://github.com/bantanger
---
## 背景

在传统 PC 端和移动端的即时通讯有较大差异，需要考虑到移动端弱网、耗电、CPU 性能等等各方面因素，因此，协定一份优秀的协议能够极大的提高即时性



## 市场调研

### Netty

使用 Netty 开发 IM（即时通讯）框架有以下好处：

1. 高性能：Netty 的异步、事件驱动的网络应用程序框架以及基于 NIO 的实现方式，使其在高并发、大流量场景下有着优异的性能表现。
2. 可扩展：Netty 的高度模块化的体系结构和适应各种传输协议和编解码器的特性，使其易于扩展和定制。
3. 高度可定制：Netty 提供了各种可定制的组件，如处理数据的编解码器、线程模型、可重用的 ByteBuf 等，使开发人员可以根据自己的需求定制和优化网络应用程序。
4. 操作简单：Netty 的 API 设计简单易用，操作上也比较清晰明了，使得开发者可以更加关注业务逻辑，而不需要过多地考虑底层的网络传输细节。
5. 跨平台性：Netty 基于 Java 开发，具有很好的跨平台性，在 Windows、Linux、Mac 等多种操作系统上都可以运行，并且支持多种开发语言的编写。

::: tip 为什么 Netty 的性能这么高

Netty 的性能之所以高，主要有以下几个方面的原因：

1. 异步的、事件驱动的网络应用程序框架：Netty 使用异步 I/O 模式和事件驱动模型，一般采用 Reactor 模式，以最小化线程之间的同步调用，从而获得更高的并发性能。
2. 基于 NIO：Netty 基于 Java NIO（New I/O）技术实现，使用了 Java NIO 提供的 Channel 和 Selector 等高效的 I/O 特性，可以同时处理多个网络连接，提高了系统的可扩展性和吞吐量。
3. 可定制的线程模型：Netty 提供了多种预定义线程模型，如单线程、多线程和主从 Reactor 线程模型，并且可以混合使用，以实现更灵活的线程管理方式。
4. 高度优化的 ByteBuf：Netty 的 ByteBuf 对象可以重用和池化，避免了频繁的对象创建和销毁，提高了系统的内存利用率，同时也减少了 GC 压力。
5. 内部数据结构的优化：Netty 内部使用了零拷贝技术和内存池，避免了不必要的数据复制，减少了内存的占用和 GC 压力。
6. 性能诊断和优化：Netty 内置了多种性能监控工具和优化建议，如可以使用 JMX 检测网络 I/O 活动，使用 MemoryPools 显示内存池的使用情况等，帮助开发者快速定位和优化系统性能问题。

:::

### 协议

协议分为公有协议和私有协议

从类型上，也可分为文本协议、二进制协议、xmpp 协议、mqtt 协议

文本协议：HTTP 协议就是一个典型的文本协议，他的优点是协议简单，易理解，便于调试，易扩展。但缺点是传输效率不高

二进制协议：IP协议就是最典型的，通过定义每一个数据位的内容来规范协议，他的优点是传输效率高，机器解析效率高，跨平台性。但缺点是开发人员难以维护，不易扩展（但只要做好规范也是易于扩展的）

XML 协议，对通信双方都采用标签的方式进行传输。优点是易于理解，扩展性好，但缺点也很明显，因为标签为一前一后，并且还要处理循环依赖的问题，传输与解析 XML 都十分耗时占用 CPU 资源，因此不太建议使用

xmpp 协议：基于 XML 协议，易读易扩展；但流量大，解析标签很占用 CPU 资源，耗电大，交互复杂

mqtt 协议：基于二进制协议，可移植性强，相比于 xmpp 协议，数据包更小；但协议简单，公有协议无法自定义一些数据格式



私有协议：一般都是基于二进制协议开发的，定制化能力强，流量小；但缺点是工作量大，难以维护，扩展性差



## 私有协议确立

私有协议由请求头和请求体组成，他们的定义在 本 IM 架构中如下

请求头：（先后顺序）

+ 指令：单聊 1103、群聊 2104 等等
+ 协议版本：类似于 HTTP 1.0、HTTP 2.0 等，便于后期协议的扩展与维护
+ messageType 消息解析类型：将协议请求体的二进制数据转化的对象，支持 json、protobuf
+ clientType 设备类型：client 登录方式可能有 移动（安卓、ios）、PC（windows、mac）、爬虫、web
+ imeiLen ：用户登录设备号长度
+ appId 平台 ID：本IM系统的架构是对接其他平台，因此存在 appId 确定平台的唯一标识
+ bodyLen：请求体长度

请求体：二进制数据，可以采用 gzip 或者其他的压缩方式进行压缩，节省字节数，提高传输效率

因此本 IM 的私有协议确立信息如下：

```text
+------------------------------------------------------+
| 指令 4byte     | 协议版本号 4byte  | 消息解析类型 4byte  |
+------------------------------------------------------+
| 设备类型 4byte  | 设备号长度 4byte  | 平台ID 4byte      | 
+------------------------------------------------------+
| 数据长度 4byte  | 数据内容(设备号imei 4byte + 请求体) 	 |
+------------------------------------------------------+
```

其中请求头共有：7 * 4 byte = 28 byte