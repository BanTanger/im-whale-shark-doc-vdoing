---
title: 接口加密校验
date: 2023-04-02 20:51:28
permalink: /pages/818de3/
categories:
  - 项目
  - 高性能IM即时通讯系统
tags:
  - 
author: 
  name: BanTanger | 半糖
  link: https://github.com/bantanger
---
## 背景

为防止接口被黑客恶意攻击，需要采用一定的加密算法对接口进行加密，并且操作接口的可以是普通用户，也可以是管理员，所以加密算法需要可逆，能解析出操作人 userId.



## 市场调研

接口加密通常通过以下措施实现：

1. HTTPS传输： 使用 HTTPS 传输协议可以保护数据在传输过程中的安全，加密数据并防止中间人攻击。
2. API密钥： 设置 API 密钥是一种简单的方法来保证你的接口是私有的，只有经过身份验证的用户才可以访问和使用。
3. 数字签名： 数字签名可以保持数据在传输过程中的完整性和真实性，确保消息没有在传输过程中被篡改或损坏。
4. 访问控制列表（ACL）： 通过访问控制列表可以限制用户对某些资源的访问，只有被授权的用户可以访问和使用。
5. API 限制： 建立限制可以避免恶意用户或过度使用 API 的用户对服务器造成过大压力，限制可以包括请求速率限制和请求数量限制。
6. 输入验证： 输入验证可以防止恶意用户传输恶意代码或数据，保护服务器免受 SQL 注入，XSS 攻击等。

以上是一些常用的接口加密措施，它们可以单独或组合使用以提高接口的安全性和保密性。



实现接口加密需要遵循以下步骤：

1. 选择加密方式： 根据实际需求，选择适合的加密算法和模式。常用的加密算法有 AES、DES、RSA 等。如果需要保持数据传输的完整性和真实性，可以使用 HMAC 算法或数字签名。
2. 生成密钥： 根据选择的加密方式生成密钥。密钥是加解密的基础，每个用户生成的密钥都不一致，必须妥善保管。
3. 在服务器端实现接口加密： 在服务器端，将接口返回值进行加密。具体实现方式包括：对明文数据进行加密后再进行传输；对传输过来的密文进行解密后处理业务数据；将密文和明文进行混合处理后进行传输等。
4. 在客户端使用接口加密： 在客户端，对请求参数进行加密，处理加密后的接口返回值。具体实现方式包括：对请求参数进行加密后再进行请求；对接口返回值进行解密后处理数据；将密文和明文进行混合处理后进行请求等。
5. 维护密钥： 密钥是接口加密的关键，应该做好密钥的安全性和维护工作。具体做法包括：生成复杂的密钥；定期更换密钥；使用安全的密钥管理工具等。

以上是接口加密的基本实现过程，具体的实现方式还需根据实际业务需求和技术环境进行适当调整。

技术选型：

我们使用 sha256 加密算法实现可逆加密，SHA256 算法是一种常用的加密算法，作为接口加密有以下优点：

1. 安全性高： SHA256 算法可以抗击大多数的攻击手段，如碰撞攻击、密钥暴力破解等。其加密强度高，安全性能好。
2. 可靠性强： SHA256 算法生成的摘要码（哈希值）具有唯一性和可靠性，即对于相同的数据输入，所生成的哈希值必定相同，对于不同的数据输入，所生成的哈希值几乎可以保证不相同。
3. 快速性能： SHA256 算法相对于其他哈希算法而言，运算时间不算慢，可以处理较大量的数据，并在约 1 秒钟以内处理 10MB 左右的数据。
4. 相对简单： 强行寻找哈希碰撞是一项众所周知的难度很高的攻击，但SHA256算法的实现比较简单。

因此，使用SHA256算法作为接口加密算法是很可靠和实用的选择，尤其是在数据安全性要求较高的场合。当然，该加密算法也有一定的缺陷，如需要考虑哈希碰撞的问题。



## 生成 UserSig

参考 [腾讯云 UserSig](https://cloud.tencent.com/document/product/269/32688)

UserSig

+ 用户登录即时通讯 IM 的密码
+ 对 UserID 等信息加密后所得到的密文

三个重要变量：

+ sdkappId：第三方对接即时通讯系统时所生成的唯一 ID，用于标识一个平台
+ secretKey：用户生成的密钥
+ expiretime：过期时间

计算 UserSig 需要放在服务端而不是客户端，原因如下：

+ 客户端被反编译破解时容易泄露密钥 secretKey
+ 泄露密钥后其他人会被盗用账号
+ 将 UserSig 加解密过程集成在服务端，通过向 AppID 提供接口的方式，可保证数据信息的安全性



签名不匹配时：

![](https://cdn.statically.io/gh/BanTanger/image-hosting@master/50.%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%A0%A1%E9%AA%8C-assets/202304022302096.png)

签名匹配：

![image-20230402230231217](https://cdn.statically.io/gh/BanTanger/image-hosting@master/50.%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%A0%A1%E9%AA%8C-assets/202304022302585.png)

签名不正确：

![image-20230402230303251](https://cdn.statically.io/gh/BanTanger/image-hosting@master/50.%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%A0%A1%E9%AA%8C-assets/202304022303682.png)